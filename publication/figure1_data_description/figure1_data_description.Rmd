---
title: "figure1_data_description"
author: "Kaixin"
date: "2023-06-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Socialmedia_Mobility/")
```


```{r initial, include=FALSE}
library(tidyverse)
library(data.table)
library(sf)
library(raster)
library(ggspatial)
library(RColorBrewer)
library(scales)
library(lubridate)

ifile_checkins_lonlat <-
  "result/01_checkins_link_lonlat.csv"

odir_result <- 
  "result/"
```


```{r color_setting, include=FALSE}
# 查看颜色盘
par(mar=c(3,4,2,2))
display.brewer.all(
  # "div", "qual", "seq"
  type = "all", 
  # Number of different colors in the palette, minimum 3, maximum depending on palette
  n = NULL 
  )

# 选择颜色
display.brewer.pal(n = 9, name = "Oranges")
pal_map <- brewer.pal(n = 9, name = "Oranges")
pal_map
```


```{r inputdata}
## WGS 84 大地坐标
crs_84 <- st_crs("EPSG:4326")  
## Albers Equal Area Conic投影
crs_al <- st_crs("+proj=aea +lat_1=25 +lat_2=47 +lon_0=105") 

checkins_lonlat <-
  fread(ifile_checkins_lonlat)

china_all <-
    sf::st_read("https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json") %>%
    st_transform(crs_al)
hainan <-
    sf::st_read("https://geo.datav.aliyun.com/areas_v3/bound/460000_full.json") %>%
    st_transform(crs_al)
```


```{r China_border}
# 去除：海南省，九段线
tmp_china <-  
    china_all %>%
    filter(!adcode %in% c("460000", "100000_JD")) %>%
    st_make_valid() %>%
    st_union()

# 海南省去除 三沙市
tmp_hainan <-  
    hainan %>%
    filter(!name %in% "三沙市") %>%
    st_make_valid() %>%
    st_union()

# 组合起来，中国边框
china_border <- 
  st_union(tmp_china, tmp_hainan) %>% 
  st_as_sf()
```


```{r test_plot_China_border, eval=FALSE}
ggplot() +
geom_sf(data = china_border)

ggplot() +
geom_sf(data = tmp_hainan)

ggplot() +
geom_sf(data = tmp_china)
```


```{r}
checkins_grid <-
  # 按照经纬度进行切片
  checkins_lonlat[, ':='(lon_cut = cut(lon, 
                                       breaks = seq(-180, 180, 0.1),
                                       include.lowest = T), 
                         lat_cut = cut(lat,
                                       breaks = seq(-90, 90, 0.1),
                                       include.lowest = T))] %>% 
  # 统计每个切片的签到数量
  .[, .(checkins_num = sum(checkins_num, na.rm = T)), by = .(lon_cut, lat_cut)] %>%
  .[, checkins_num_log := log(checkins_num, base = 10)] %>%
  # 计算每个切片的中心点经纬度
  .[, ':='(lon_grid = as.double(lon_cut)*0.1-180.05,
           lat_grid = as.double(lat_cut)*0.1-90.05)]

checkins_raster <-
  # 生成raster，使用经纬度和属性值
  rasterFromXYZ(xyz = checkins_grid[, .(lon_grid, lat_grid, checkins_num_log)],
                res = c(0.1, 0.1),
                crs = "EPSG:4326") %>%
  # mask操作
  raster::mask(st_transform(china_border, crs_84)) %>%
  stars::st_as_stars() %>%
  st_as_sf() %>%
  # 转换为投影坐标系
  st_transform(crs = crs_al)

# ggplot(checkins_raster) +
#   geom_sf(mapping = aes(fill = checkins_num_log))
```


```{r plotting}
# 绘制全域
p1 <-
  ggplot() +
  geom_sf(data = checkins_raster,
          mapping = aes(fill = checkins_num_log),
          color = NA) +
    scale_fill_gradientn(name = "Number of posts",
                         limits = c(0, 7),
                         breaks = seq(0, 7, 1),
                         label = c(expression(10^0), expression(10^1),
                                   expression(10^2), expression(10^3),
                                   expression(10^4), expression(10^5),
                                   expression(10^6), expression(10^7)),
                         # low = rgb(255, 248, 225, maxColorValue = 255),
                         # mid= rgb(255, 236, 179, maxColorValue = 255),
                         # high = rgb(153, 52, 4, maxColorValue = 255),
                         # fill = pal_map,
                         colors = pal_map,
                         na.value = "transparent",
                         guide = "colourbar",
                         aesthetics = "fill") +
    geom_sf(data = china_all,
            size = .2, fill = "transparent", color = "#060d1b")



# 截取南海
p2 <-
    p1 +
    coord_sf(crs = crs_84) + ## 将投影坐标转换为大地坐标,方便下面使用经纬度截取
    scale_x_continuous(expand = c(0, 0), 
                       limits = c(107, 122), 
                       breaks = seq(70, 140, 10)) +
    scale_y_continuous(expand = c(0, 0), 
                       limits = c(2, 24), 
                       breaks = seq(10, 60, 10)) +
    guides(fill = "none", color = "none") +
    theme_bw() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.title = element_blank())

# 图形拼接
p3 <-
  p1 + 
  coord_sf(crs = crs_al, # 投影坐标系
           default_crs = crs_84) + # 大地坐标，方便后续使用经纬度定位标签位置
  # annotate(geom = "text",   # 审图号
  #          x = 80, 
  #          y = 18,
  #          label = "GS(2019)6379",
  #          vjust = 0, 
  #          hjust = 0) +  
  scale_x_continuous(expand = c(0, 0),
                     limits = c(72, 142),
                     breaks = seq(70, 140, 10)) +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(17, 55.5), 
                     breaks = seq(10, 60, 10)) +
  guides(fill = guide_colorbar(title.position = "left",
                               barheight = 20)) + ### 需要调整
  theme_bw() +
  theme(axis.text = element_text(color = "black"),
        axis.title = element_blank(),
        legend.title = element_text(angle = 90, hjust = 0.5),  ## 需要调整
        legend.text = element_text(size = 8),
        legend.position = "right",
        legend.background = element_rect(fill = NA, color = NA),
        legend.margin = margin(t = 0, l = 2)  ### 需要调整
        ) +
  annotation_scale(location = "bl") + # 设置距离刻度尺
  annotation_north_arrow(location = "tl", 
                         style = north_arrow_nautical(fill = c("grey40", 
                                                               "white"), 
                                                      line_col = "grey20")) +
  annotation_custom(ggplotGrob(p2), ## 子图插入
                    xmin = 122,
                    xmax = 138, 
                    ymin = 15,
                    ymax = 29)
```


```{r save_plot, eval=TRUE}
time <-
  str_sub(as.character(now()), start = 1, end = -8) %>%
  str_replace(" ", "_")

filename_temp <- paste0("02_plot_", time, ".jpg")

ggsave(filename = filename_temp,
       plot = p3,
       path = odir_result,
       width = 180,
       height = 210,
       units = "mm",
       dpi = 300)
```


