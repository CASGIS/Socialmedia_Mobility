---
title: "03_c_"
author: "Kaixin"
date: "2023-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/SMobility_paper_v2/02_data_validation/")
```


```{r initial, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table)
library(patchwork)
library(correlation)
library(lemon)
library(janitor)

options(max.print = 200)
options(datatable.print.topn = 100)

ifile_CMI_city_relative <-
  "result/03_a_CMI_city_relative.csv"

ifile_daily_usercount_travel_relative <-
  "result/03_b_daily_usercount_travel_relative.csv"

ifile_city_postcount_ranking <-
  "result/03_b_city_postcount_ranking_v2.csv"

ifile_city_info <-
  "data/03_a_baidu_city_movement_intensity/Index_City_CH_EN.csv"

odir_result <-
  "result/"
```


```{r input_data}
CMI_city_relative <- 
  fread(ifile_CMI_city_relative)

daily_usercount_travel_relative <-
  fread(ifile_daily_usercount_travel_relative)

city_postcount_ranking <-
  fread(ifile_city_postcount_ranking)

city_info <-
  fread(ifile_city_info, header = T) %>%
  clean_names() %>%
  .[, .(city_ch, city_pinyin = city_en, code = gb_city)] %>%
  .[, code := as.character(code)]
```


```{r input_data_show}
CMI_city_relative
daily_usercount_travel_relative
city_postcount_ranking
city_info
```


```{r data_process}
CMI_city_relative[, code := str_sub(city, start = -6, end = -3)]

CMI_city_relative_ch <-
  merge(CMI_city_relative,
        city_info,
        all.x = T,
        by = "code")

CMI_city_relative_ch %>%
  .[, city_name := city_ch] %>%
  .[str_detect(city_ch, "市$"), city_name := str_replace(city_ch, "市$", "")] %>%
  .[str_detect(city_ch, "地区$"), city_name := str_replace(city_ch, "地区$", "")] %>%
  .[str_detect(city_ch, "自治州$"), city_name := str_replace(city_ch, "自治州$", "")] %>%
  .[str_detect(city_ch, "自治$"), city_name := str_replace(city_ch, "自治$", "")] %>%
  .[str_detect(city_ch, "自$"), city_name := str_replace(city_ch, "自$", "")]

daily_usercount_travel_relative %>%
  .[, city_name := city] %>%
  .[str_detect(city_name, "市$"), city_name := str_replace(city_name, "市$", "")] %>%
  .[str_detect(city_name, "地区$"), city_name := str_replace(city_name, "地区$", "")] %>%
  .[str_detect(city_name, "自治州$"), city_name := str_replace(city_name, "自治州$", "")]


# setdiff(union(CMI_city_relative_ch$city_name, daily_usercount_travel_relative$city_name),
#         intersect(CMI_city_relative_ch$city_name, daily_usercount_travel_relative$city_name))
# 
# setdiff(daily_usercount_travel_relative$city_name, CMI_city_relative_ch$city_name)
# 
# setdiff(CMI_city_relative_ch$city_name, daily_usercount_travel_relative$city_name)

CMI_weibo <-
  merge(CMI_city_relative_ch,
        daily_usercount_travel_relative,
        by.x = c("city_name", "date"),
        by.y = c("city_name", "created_at"))

city_select <-
  city_postcount_ranking %>%
  .[, id := .I] %>%
  .[, prop_cumsum := cumsum(postcount_prop)]
```


```{r pearson_analysis}
# Pearson correlation
pearson_data <-
  CMI_weibo[city_name %in% city_select[1:49, city]]

cor_result <-
  pearson_data[, .(city_name, city_pinyin)] %>%
  unique() %>%
  .[, ':='(cor_value = NA_real_, p_value = NA_real_)]

for(i in 1:nrow(cor_result)){

  city <- cor_result[i, city_name]
  
  pearson_test <-
    cor.test(pearson_data[city_name == city, CMI_7MA_relative],
             pearson_data[city_name == city, usercount_7MA_relative],
             method = "pearson")
  
  cor_result[i, "cor_value"] <- pearson_test$estimate
  cor_result[i, "p_value"] <- pearson_test$p.value
}

cor_result_filter <-
  cor_result[cor_value > 0.7]

# add text
cor_result_filter %>%
  .[, ":="(cor_value_round = round(cor_value, digits = 2), 
           p_value_round = round(p_value, digits = 2))] %>%
  .[, label := paste0("r: ", str_pad(cor_value_round, 4, "right", "0"),
                      "\np-value: ", p_value_round)]
```


```{r plot}
plotdata <-
  CMI_weibo[!is.na(CMI_relative) & 
              !is.na(CMI_7MA_relative) & 
              !is.na(usercount_relative) & 
              !is.na(usercount_7MA_relative)] %>%
  .[city_name %in% cor_result_filter[, city_name]] %>%  ###
  .[, .(city_pinyin,
        date, 
        CMI_relative, 
        CMI_7MA_relative,
        usercount_relative, 
        usercount_7MA_relative)] %>%
  melt(id.vars = c("city_pinyin", "date"))

# 确定y轴坐标范围，根据7MA_relative确定
# summary(CMI_weibo[city_name %in% cor_result_filter[, city_name]])

plot <-
  ggplot(plotdata) +
  geom_line(mapping = aes(x = date, 
                          y = value, 
                          color = variable,
                          alpha = variable),
            linewidth = 0.3) +
  geom_text(data = cor_result_filter,
            mapping = aes(x = ymd("2020-05-02"),
                          y = 0.6,
                          label = label),
            size = 2.5,
            lineheight = 1,
            hjust = "inward") +
  geom_hline(yintercept = 0,
             color = "black",
             linetype = "solid",
             # size = 0.5,
             alpha = 0.5) +
  geom_vline(xintercept = ymd("2020-01-20"), # 官宣人传人
             color = "red",
             linetype = "dashed",
             linewidth = 0.3
             ) +
  scale_color_manual(values = c("CMI_relative" = "darkorange",
                                "CMI_7MA_relative" = "darkorange",
                                "usercount_relative" = "deepskyblue",
                                "usercount_7MA_relative" = "deepskyblue"),
                     labels = c("CMI_relative" = "Baidu index",
                                "CMI_7MA_relative" = "Baidu index (7MA)",
                                "usercount_relative" = "Weibo index",
                                "usercount_7MA_relative" = "Weibo index (7MA)")) +
  scale_alpha_manual(values = c("CMI_relative" = 0.2,
                                "CMI_7MA_relative" = 1,
                                "usercount_relative" = 0.2,
                                "usercount_7MA_relative" = 1),
                     labels = c("CMI_relative" = "Baidu index",
                                "CMI_7MA_relative" = "Baidu index (7MA)",
                                "usercount_relative" = "Weibo index",
                                "usercount_7MA_relative" = "Weibo index (7MA)")) +
  scale_x_date(breaks = ymd(c("2020-01-01",
                              "2020-02-01",
                              "2020-03-03",
                              "2020-04-01",
                              "2020-05-01")),
               date_labels = "%b") +
  scale_y_continuous(breaks = seq(-1, 1, 0.5),
                     limits = c(-1, 1),
                     labels = c("-100%", "-50%", "0", "+50%", "+100%")) +
  facet_wrap(~ city_pinyin, ncol = 6) +
  labs(
       # x = "Date",
       y = "Relative change of mobility index") +
  theme_bw() +
  theme(axis.title.y = element_text(size = 12),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.margin = margin(t = -5),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.key.width = unit(1.5, "cm"),
        legend.text = element_text(size = 11),
        strip.background = element_rect(fill = NA, color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing.x = unit(12, "pt")
        ) +
  guides(colour = guide_legend(nrow = 1, override.aes = list(linewidth = 1)))


```


```{r save_plot, eval=FALSE}
time <-
  paste0(str_replace(now(), " ", "_"))

filename_temp <- paste0("03_c_plot_", time, ".pdf")

ggsave(plot,
       device = cairo_pdf,
       filename = filename_temp,
       path = odir_result,
       width = 10,
       height = 7)
```








